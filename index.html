<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- interactive-widget fixes Android keyboard resizing issues -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>BrandAI | Support</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        black: '#000000',
                        dark: '#0a0a0a',
                        accent: {
                            primary: '#6366f1',
                            secondary: '#a855f7',
                            emerald: '#10b981',
                            rose: '#f43f5e'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #000000;
            color: #ffffff;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* --- Chat Bubble Styles (WhatsApp Feel) --- */
        .bubble-ai {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-top-left-radius: 4px;
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
            border-bottom-left-radius: 20px;
            color: #e2e8f0;
        }

        .bubble-user {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 4px;
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .input-pro {
            background: #0d0d0d;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        .input-pro:focus {
            border-color: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.15);
            outline: none;
        }

        @keyframes premiumReveal {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-reveal { animation: premiumReveal 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .btn-gradient-pro {
            background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899);
            background-size: 200% auto;
            transition: 0.5s;
        }
        .btn-gradient-pro:hover { background-position: right center; }

        .error-field { border-color: #f43f5e !important; }

        /* --- PUBLIC MODE LOCKDOWN CSS (FIXED) --- */
        /* Used when ?u= & id= are present */
        body.public-mode #main-header,
        body.public-mode #main-nav,
        body.public-mode #logout-btn,
        body.public-mode #chat-back-btn,
        body.public-mode #auth-view,
        body.public-mode #home-view,
        body.public-mode #creator-view {
            display: none !important;
        }
        
        body.public-mode #app-shell {
            display: block !important;
        }

        /* Fixed Chat View Layout for Mobile */
        body.public-mode #chat-view {
            display: flex !important;
            flex-direction: column;
            position: fixed;
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            z-index: 9999;
            background: #000000;
            height: 100vh; /* Fallback */
        }

        /* Use Dynamic Viewport Height for modern mobile browsers */
        @supports (height: 100dvh) {
            body.public-mode #chat-view { height: 100dvh; }
        }

        /* Ensure stream takes available space and scrolls */
        body.public-mode #chat-stream {
            flex-grow: 1;
            overflow-y: auto;
            height: auto;
            padding-bottom: 20px;
        }

        /* Fix Input Area to bottom safely */
        body.public-mode #chat-input-area {
            position: sticky; 
            bottom: 0;
            background: #000;
            z-index: 99999;
            width: 100%;
            padding-bottom: env(safe-area-inset-bottom); /* For iPhone Home Bar */
        }

        body.public-mode main { padding: 0 !important; }

        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="selection:bg-accent-primary/30">

    <!-- Global Notifications -->
    <div id="toast-bin" class="fixed top-6 left-1/2 -translate-x-1/2 z-[200] w-[90%] max-w-sm space-y-3 pointer-events-none"></div>

    <!-- Auth Section -->
    <section id="auth-view" class="min-h-screen flex items-center justify-center px-6">
        <div class="w-full max-w-[400px] animate-reveal">
            <div class="text-center mb-10">
                <div class="inline-flex w-16 h-16 bg-white/5 border border-white/10 rounded-2xl items-center justify-center mb-6">
                    <i class="fas fa-brain text-3xl text-accent-primary"></i>
                </div>
                <h1 class="text-4xl font-extrabold tracking-tight">BrandAI Hub</h1>
                <p class="text-slate-500 font-medium">Professional Intelligence Gateway</p>
            </div>

            <div class="auth-slider mb-8 h-14 relative bg-white/5 rounded-2xl p-1 flex">
                <div id="slider-bg" class="absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl transition-all duration-300"></div>
                <button onclick="switchAuth('login')" class="flex-1 relative z-10 text-sm font-bold">Sign In</button>
                <button onclick="switchAuth('signup')" class="flex-1 relative z-10 text-sm font-bold">Register</button>
            </div>

            <div class="space-y-4">
                <input type="email" id="auth-email" class="w-full input-pro p-5 rounded-2xl text-sm" placeholder="Email Address">
                <input type="password" id="auth-pass" class="w-full input-pro p-5 rounded-2xl text-sm" placeholder="Password">
                
                <button onclick="performAuth()" id="auth-btn" class="w-full btn-gradient-pro py-5 rounded-2xl font-bold text-sm shadow-xl shadow-accent-primary/20">
                    Connect Terminal
                </button>

                <div class="relative py-4 text-center">
                    <span class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-700">Enterprise Access</span>
                </div>

                <button onclick="googleAuth()" class="w-full bg-white text-black py-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-3 hover:bg-slate-100 transition">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5">
                    Continue with Google
                </button>
            </div>
        </div>
    </section>

    <!-- App Shell -->
    <div id="app-shell" class="hidden">
        
        <!-- Header (Hidden in Public Mode) -->
        <header id="main-header" class="fixed top-0 w-full z-50 bg-black/80 backdrop-blur-xl border-b border-white/5 px-6 py-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 btn-gradient-pro rounded-xl flex items-center justify-center">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <span class="text-2xl font-extrabold tracking-tighter">BrandAI</span>
                </div>
                <button id="logout-btn" onclick="signOut()" class="text-[10px] font-bold text-slate-500 hover:text-white uppercase tracking-widest transition">log out</button>
            </div>
        </header>

        <main class="pt-28 pb-32 px-6 max-w-7xl mx-auto">
            
            <!-- Grid View -->
            <section id="home-view" class="animate-reveal">
                <div class="flex items-end justify-between mb-12">
                    <div>
                        <h2 class="text-5xl font-extrabold tracking-tighter">Directory</h2>
                        <p class="text-slate-500 font-medium">ai support agents active across your ecosystem.</p>
                    </div>
                </div>
                <div id="brands-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards are loaded here dynamically -->
                </div>
            </section>

            <!-- Deployment Studio -->
            <section id="creator-view" class="hidden animate-reveal max-w-4xl mx-auto">
                <div class="mb-10">
                    <h2 class="text-4xl font-extrabold tracking-tight">AI Studio</h2>
                    <p class="text-slate-500">Train and deploy your brand-specific neural model.</p>
                </div>

                <!-- Create Agent Form -->
                <div class="glass-card p-8 md:p-12 rounded-[2.5rem] space-y-10 mb-12">
                    <div class="space-y-6">
                        <div class="flex items-center gap-3 border-b border-white/5 pb-4">
                            <i class="fas fa-id-card text-accent-primary"></i>
                            <h4 class="font-bold text-lg">Identity & Analysis</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase tracking-widest text-slate-500 ml-1">Brand Name</label>
                                <input type="text" id="b-name" class="w-full input-pro p-4 rounded-xl text-sm" placeholder="e.g. Nexus Global">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase tracking-widest text-slate-500 ml-1">Website URL (Required)</label>
                                <input type="url" id="b-url" class="w-full input-pro p-4 rounded-xl text-sm" placeholder="https://yourbrand.com">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-black uppercase tracking-widest text-slate-500 ml-1">Brand Logo URL (Optional)</label>
                            <input type="text" id="b-logo" class="w-full input-pro p-4 rounded-xl text-sm" placeholder="https://image-link.com/logo.png">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-black uppercase tracking-widest text-slate-500 ml-1">Neural Knowledge Base</label>
                            <textarea id="b-kb" rows="5" class="w-full input-pro p-5 rounded-2xl text-sm resize-none" placeholder="Paste your brand info, FAQs, and policies here for the AI to analyze..."></textarea>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="flex items-center gap-3 border-b border-white/5 pb-4">
                            <i class="fas fa-headset text-accent-emerald"></i>
                            <h4 class="font-bold text-lg">Escalation Channels</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase tracking-widest text-slate-500 ml-1">WhatsApp Bridge</label>
                                <input type="text" id="b-wa" class="w-full input-pro p-4 rounded-xl text-sm" placeholder="+91 0000000000">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase tracking-widest text-slate-500 ml-1">Support Email</label>
                                <input type="email" id="b-email" class="w-full input-pro p-4 rounded-xl text-sm" placeholder="care@brand.com">
                            </div>
                        </div>
                    </div>

                    <button onclick="deployAgent()" id="deploy-btn" class="w-full btn-gradient-pro py-5 rounded-2xl font-bold text-lg shadow-2xl">
                        Synthesize & Deploy AI
                    </button>
                </div>

                <!-- Studio: Bot Management List -->
                <div class="mb-10 mt-12">
                    <h3 class="text-2xl font-extrabold tracking-tight mb-6 flex items-center gap-3">
                        <i class="fas fa-network-wired text-accent-secondary"></i> Neural Configuration
                    </h3>
                    <div id="studio-agent-list" class="space-y-4">
                        <!-- List populated by JS -->
                    </div>
                </div>
            </section>
        </main>

        <!-- Chat View (Unified for Public & Admin) -->
        <section id="chat-view" class="hidden fixed inset-0 z-[100] bg-black flex flex-col">
            <!-- Header (Dynamic) -->
            <header class="p-4 bg-black/90 backdrop-blur-md border-b border-white/5 flex items-center justify-between z-20 sticky top-0">
                <div class="flex items-center gap-3">
                    <button id="chat-back-btn" onclick="showSection('home-view')" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center hover:bg-white/10 mr-1"><i class="fas fa-arrow-left text-sm"></i></button>
                    
                    <!-- WhatsApp-style Header Info -->
                    <div class="relative w-10 h-10 rounded-full bg-white/10 overflow-hidden border border-white/10">
                        <img id="chat-header-img" class="w-full h-full object-cover" src="">
                    </div>
                    <div>
                        <h4 id="active-brand-name" class="font-bold text-base tracking-tight leading-tight">Agent</h4>
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 bg-accent-emerald rounded-full animate-pulse"></span>
                            <span class="text-[10px] font-medium text-accent-emerald/80">Online</span>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Chat Area -->
            <div id="chat-stream" class="flex-1 overflow-y-auto p-4 space-y-6 max-w-4xl mx-auto w-full pb-6"></div>
            
            <!-- Input Area -->
            <div id="chat-input-area" class="p-4 bg-black border-t border-white/5 z-20">
                <div class="max-w-4xl mx-auto flex items-end gap-3 bg-white/5 p-2 pr-2 rounded-[1.5rem] border border-white/5 focus-within:border-accent-primary/50 transition-colors">
                    <!-- Added inputmode and autofocus for better mobile keyboard handling -->
                    <textarea id="chat-input" rows="1" class="flex-1 bg-transparent border-none outline-none p-3 text-sm max-h-24 resize-none" placeholder="Type a message..." autocomplete="off" inputmode="text"></textarea>
                    <button onclick="dispatchMessage(event)" class="w-11 h-11 btn-gradient-pro rounded-full flex-shrink-0 flex items-center justify-center shadow-lg transform active:scale-90 transition"><i class="fas fa-paper-plane text-xs text-white"></i></button>
                </div>
            </div>
        </section>

        <!-- Navbar (Hidden in Public Mode) -->
        <nav id="main-nav" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] max-w-sm glass-card p-4 rounded-full flex justify-around items-center z-40">
            <button onclick="showSection('home-view')" class="flex flex-col items-center gap-1 group">
                <i class="fas fa-th-large text-xl text-accent-primary transition group-active:scale-75"></i>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-500">Explore</span>
            </button>
            <button onclick="showSection('creator-view')" class="flex flex-col items-center gap-1 group">
                <i class="fas fa-wand-magic-sparkles text-xl text-slate-500 transition group-active:scale-75"></i>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-500">Studio</span>
            </button>
        </nav>
    </div>

    <script>
        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyBiHHb4uZH_D2dWN2zgIJzjlFeO0fvYvPY",
            authDomain: "ai-brand-supporter.firebaseapp.com",
            databaseURL: "https://ai-brand-supporter-default-rtdb.firebaseio.com",
            projectId: "ai-brand-supporter",
            storageBucket: "ai-brand-supporter.firebasestorage.app",
            messagingSenderId: "257519339474",
            appId: "1:257519339474:web:a99c8b207e02c23b5fea0b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const GROQ_KEY = "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";

        // --- State Management ---
        let userState = null;
        let activeAgent = null;
        let authMode = 'login';

        // --- Session Management (Private Chats) ---
        function getChatSessionId() {
            let sid = localStorage.getItem('brand_ai_session_id');
            if (!sid) {
                // Generate unique session ID for this browser
                sid = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('brand_ai_session_id', sid);
            }
            return sid;
        }

        // --- Public Access Logic Detection ---
        const urlParams = new URLSearchParams(window.location.search);
        const publicOwnerId = urlParams.get('u'); 
        const publicAgentId = urlParams.get('id'); 
        const isPublicMode = (publicOwnerId && publicAgentId);

        // Immediate CSS Injection for Public Mode to prevent UI Flash
        if(isPublicMode) {
            document.body.classList.add('public-mode');
        }

        // Helper to get correct path owner
        function getOwnerId() {
            return isPublicMode ? publicOwnerId : (userState ? userState.uid : null);
        }

        // --- UI Functions ---
        function notify(msg, type = 'err') {
            const bin = document.getElementById('toast-bin');
            const t = document.createElement('div');
            t.className = `glass-card p-4 rounded-2xl flex items-center gap-3 animate-reveal border-l-4 ${type === 'err' ? 'border-accent-rose' : 'border-accent-emerald'}`;
            t.innerHTML = `
                <i class="fas ${type === 'err' ? 'fa-shield-halved text-accent-rose' : 'fa-check-circle text-accent-emerald'}"></i> 
                <div>
                    <p class="text-[10px] font-black uppercase opacity-50">${type === 'err' ? 'System Firewall' : 'System Success'}</p>
                    <p class="text-xs font-bold">${msg}</p>
                </div>`;
            bin.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 500); }, 4000);
        }

        function switchAuth(m) {
            authMode = m;
            document.getElementById('slider-bg').style.transform = m === 'login' ? 'translateX(0)' : 'translateX(100%)';
            document.getElementById('auth-btn').innerText = m === 'login' ? 'Connect Terminal' : 'Initialize Identity';
        }

        async function performAuth() {
            const email = document.getElementById('auth-email');
            const pass = document.getElementById('auth-pass');
            if(!email.value || !pass.value) return email.classList.add('error-field');

            const btn = document.getElementById('auth-btn');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Securing Link...`;

            try {
                if(authMode === 'login') await auth.signInWithEmailAndPassword(email.value, pass.value);
                else await auth.createUserWithEmailAndPassword(email.value, pass.value);
            } catch(e) {
                notify(e.message, 'err');
                btn.innerText = 'Connect Terminal';
            }
        }

        function googleAuth() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => notify(e.message, 'err'));
        }

        function signOut() { auth.signOut().then(() => location.reload()); }

        function showSection(id) {
            if(isPublicMode) return; // Locked in public mode
            ['auth-view', 'home-view', 'creator-view', 'chat-view'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            // Refresh lists if entering needed sections
            if(id === 'home-view' || id === 'creator-view') loadAgents();
        }

        function secureCopy(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => notify("Public Link Copied", "success"))
                .catch(() => notify("Clipboard Access Denied", "err"));
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px";
                document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try { document.execCommand('copy'); notify("Public Link Copied", "success"); } 
                catch (err) { notify("Copy Failed", "err"); }
                document.body.removeChild(textArea);
            }
        }

        function copyPublicLink(agentId) {
            if(!userState) return;
            const url = `${window.location.origin}${window.location.pathname}?id=${agentId}&u=${userState.uid}`;
            secureCopy(url);
        }

        // --- Core Logic ---

        async function deployAgent() {
            if(!userState) return notify("Session Expired");
            const fields = ['b-name', 'b-url', 'b-kb', 'b-logo', 'b-wa', 'b-email'];
            const vals = {};
            fields.forEach(f => vals[f] = document.getElementById(f).value);

            if(!vals['b-name'] || !vals['b-url'] || !vals['b-kb']) return notify('Identity, Website & Knowledge Base are required.');

            const btn = document.getElementById('deploy-btn');
            btn.innerHTML = `<i class="fas fa-atom fa-spin"></i> Synthesizing...`;

            const data = {
                name: vals['b-name'],
                url: vals['b-url'],
                kb: vals['b-kb'],
                logo: vals['b-logo'] || 'https://cdn-icons-png.flaticon.com/512/1162/1162456.png',
                wa: vals['b-wa'] || 'N/A',
                email: vals['b-email'] || 'N/A',
                ts: Date.now()
            };

            try {
                await db.ref(`brands/${userState.uid}`).push(data);
                notify('Agent Deployed', 'success');
                fields.forEach(f => document.getElementById(f).value = '');
                showSection('home-view'); // Switch to home to see it
            } catch(e) {
                notify(e.message, 'err');
            }
            btn.innerText = "Synthesize & Deploy AI";
        }

        function deleteAgent(agentId) {
            if(confirm('Terminate this neural node permanently?')) {
                db.ref(`brands/${userState.uid}/${agentId}`).remove()
                .then(() => notify('Agent Terminated', 'success'))
                .catch(e => notify(e.message, 'err'));
            }
        }

        // Unified loading for Directory and Studio List
        function loadAgents() {
            if(isPublicMode || !userState) return; 

            const grid = document.getElementById('brands-grid');
            const studioList = document.getElementById('studio-agent-list');

            db.ref(`brands/${userState.uid}`).on('value', snap => {
                grid.innerHTML = '';
                studioList.innerHTML = '';

                if(!snap.exists()) {
                    grid.innerHTML = `<div class="col-span-full py-10 text-center opacity-30"><p>No agents active.</p></div>`;
                    studioList.innerHTML = `<div class="p-4 border border-white/10 rounded-xl text-center text-slate-500 text-sm">No active neural nodes. Create one above.</div>`;
                    return;
                }

                snap.forEach(child => {
                    const b = child.val();
                    const id = child.key;
                    grid.innerHTML += `
                        <div onclick="initiateChat('${id}', '${b.name}', '${b.logo}')" class="glass-card p-8 rounded-[2rem] cursor-pointer hover:border-accent-primary transition-all group relative overflow-hidden">
                            <div class="flex items-start justify-between mb-6">
                                <div class="w-14 h-14 bg-white/5 rounded-2xl overflow-hidden border border-white/10 flex items-center justify-center">
                                    <img src="${b.logo}" class="w-full h-full object-cover" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1162/1162456.png'">
                                </div>
                                <div class="bg-accent-emerald/10 text-accent-emerald text-[8px] font-black px-2 py-1 rounded-full uppercase">active</div>
                            </div>
                            <h3 class="text-2xl font-bold mb-1 tracking-tight">${b.name}</h3>
                            <p class="text-[10px] font-medium text-slate-500 uppercase tracking-widest truncate">${b.url}</p>
                            <div class="mt-8 flex items-center justify-between">
                                <span class="text-[10px] font-black text-accent-primary group-hover:tracking-[0.1em] transition-all uppercase">Open Terminal<i class="fas fa-arrow-right ml-1"></i></span>
                            </div>
                        </div>
                    `;

                    studioList.innerHTML += `
                        <div class="glass-card p-4 rounded-xl flex items-center justify-between group">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 bg-white/5 rounded-lg overflow-hidden">
                                    <img src="${b.logo}" class="w-full h-full object-cover" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1162/1162456.png'">
                                </div>
                                <div>
                                    <h5 class="font-bold text-sm">${b.name}</h5>
                                    <p class="text-[10px] text-slate-500 truncate max-w-[150px]">${id}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="copyPublicLink('${id}')" class="px-3 py-2 rounded-lg bg-white/5 hover:bg-accent-primary text-xs font-bold transition">Copy Link</button>
                                <button onclick="deleteAgent('${id}')" class="w-8 h-8 rounded-lg bg-white/5 hover:bg-accent-rose text-white/50 hover:text-white transition flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        async function initiateChat(id, name, logo) {
            activeAgent = { id, name };
            document.getElementById('active-brand-name').innerText = name;
            
            // Header Image Update
            const img = document.getElementById('chat-header-img');
            img.src = logo || 'https://cdn-icons-png.flaticon.com/512/1162/1162456.png';
            img.onerror = function() { this.src = 'https://cdn-icons-png.flaticon.com/512/1162/1162456.png'; };

            document.getElementById('chat-stream').innerHTML = '';
            
            document.getElementById('chat-view').classList.remove('hidden');
            if(!isPublicMode) {
                document.getElementById('home-view').classList.add('hidden');
                document.getElementById('creator-view').classList.add('hidden');
            }

            pushMsg('assistant', `Synchronized with **${name}**. How can I help?`);

            const ownerId = getOwnerId();
            if(!ownerId) return;

            // ISOLATION FIX: Use Session ID in Path
            const sessionId = getChatSessionId();
            
            // Load history for specific session
            db.ref(`chats/${ownerId}/${id}/${sessionId}`).limitToLast(15).once('value', s => {
                s.forEach(m => pushMsg(m.val().role, m.val().content));
            });
        }

        function pushMsg(role, content) {
            const stream = document.getElementById('chat-stream');
            const isUser = role === 'user';
            const msgDiv = document.createElement('div');
            
            // Format line breaks
            content = content.replace(/\n/g, '<br>');
            
            msgDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} animate-reveal`;
            msgDiv.innerHTML = `
                <div class="${isUser ? 'bubble-user' : 'bubble-ai'} max-w-[85%] px-5 py-3 text-[15px] leading-relaxed shadow-sm">
                    ${content}
                </div>
            `;
            stream.appendChild(msgDiv);
            stream.scrollTop = stream.scrollHeight;
        }

        // Updated Dispatch Message with Strict Language Detection & Session Isolation
        async function dispatchMessage(e) {
            // Prevent default form submission or focus loss if button clicked
            if(e) e.preventDefault();

            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            pushMsg('user', text);
            input.value = '';
            input.style.height = 'auto'; // Reset height
            
            // KEYBOARD FIX: Force focus immediately and after a short delay
            input.focus();
            setTimeout(() => { input.focus(); }, 50);

            const ownerId = getOwnerId();
            if(!ownerId) return notify("Connection Error");
            
            const sessionId = getChatSessionId();

            const snap = await db.ref(`brands/${ownerId}/${activeAgent.id}`).once('value');
            const b = snap.val();

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${GROQ_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { 
                                role: "system", 
                                content: `You are a professional AI Assistant for "${b.name}".
                                BRAND DATA: ${b.kb}.
                                BRAND WEBSITE: ${b.url}.
                                
                                STRICT DYNAMIC LANGUAGE POLICY:
                                1. ANALYZE the user's input language first.
                                2. MATCH the user's language EXACTLY in your reply.
                                   - If user speaks English -> Reply in English.
                                   - If user speaks Hindi/Hinglish -> Reply in Hindi.
                                3. DO NOT force Hindi if the user is typing in English.
                                
                                Use provided data only. If answer not found, give WhatsApp: ${b.wa} or Email: ${b.email}.` 
                            },
                            { role: "user", content: text }
                        ]
                    })
                });
                const d = await res.json();
                const ai = d.choices[0].message.content;
                pushMsg('assistant', ai);
                
                // Save Chat (ISOLATED PATH)
                db.ref(`chats/${ownerId}/${activeAgent.id}/${sessionId}`).push({ role: 'user', content: text });
                db.ref(`chats/${ownerId}/${activeAgent.id}/${sessionId}`).push({ role: 'assistant', content: ai });
            } catch(e) {
                pushMsg('assistant', "Neural link unstable.");
            }
        }

        // Auto-resize textarea for mobile friendliness
        document.getElementById('chat-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // --- Entry Point Logic ---
        auth.onAuthStateChanged(user => {
            if (isPublicMode) {
                // PUBLIC MODE: Strictly hide auth and load chat
                userState = user; 
                document.getElementById('auth-view').remove(); // Completely remove auth view
                document.getElementById('app-shell').classList.remove('hidden');
                
                // Fetch public agent details
                db.ref(`brands/${publicOwnerId}/${publicAgentId}`).once('value').then(snap => {
                    if(snap.exists()) {
                        const d = snap.val();
                        // Call initiateChat with correct logo
                        initiateChat(publicAgentId, d.name, d.logo);
                    } else {
                        document.body.innerHTML = "<div style='color:white;text-align:center;padding:50px;font-family:sans-serif'>Invalid or Deleted Neural Link.</div>";
                    }
                });

            } else if (user) {
                // ADMIN MODE: Logged in
                userState = user;
                document.getElementById('app-shell').classList.remove('hidden');
                document.getElementById('auth-view').classList.add('hidden');
                showSection('home-view');
            } else {
                // LOGGED OUT: Show Auth
                userState = null;
                document.getElementById('app-shell').classList.add('hidden');
                document.getElementById('auth-view').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>