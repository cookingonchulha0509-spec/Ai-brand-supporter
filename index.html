<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Esports Tournament</title>
    <!-- Tailwind CSS & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* Modern Gaming Theme */
        :root {
            --primary: #6366f1; /* Indigo */
            --accent: #f43f5e; /* Rose */
            --dark: #0f172a;
            --glass: rgba(30, 41, 59, 0.7);
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--dark); color: white; -webkit-tap-highlight-color: transparent; }
        .font-gaming { font-family: 'Rajdhani', sans-serif; }
        
        /* Glassmorphism */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Animations */
        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .nav-item.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .nav-item { transition: all 0.3s; }
        
        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Loader */
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid var(--accent); width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col relative">

    <!-- SPLASH SCREEN -->
    <div id="splash" class="fixed inset-0 bg-slate-900 z-[60] flex flex-col items-center justify-center transition-opacity duration-700">
        <h1 class="text-5xl font-gaming font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-rose-500 tracking-wider">ESPORTS<br>PRO</h1>
        <div class="mt-4 spinner"></div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="fixed inset-0 bg-[url('https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=2070')] bg-cover bg-center z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm"></div>
        <div class="relative z-10 h-full flex flex-col justify-center px-6">
            <h2 class="text-4xl font-gaming font-bold mb-2">Welcome, <br><span class="text-indigo-400">Gamer</span></h2>
            <p class="text-gray-400 mb-8 text-sm">Join the ultimate battleground.</p>

            <!-- Login Form -->
            <div id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="Email Address" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 outline-none focus:border-indigo-500 transition">
                <input type="password" id="password" placeholder="Password" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 outline-none focus:border-indigo-500 transition">
                
                <button onclick="emailLogin()" class="w-full bg-indigo-600 py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/30 hover:bg-indigo-500 transition">LOGIN</button>
                
                <div class="flex items-center gap-4 my-4">
                    <div class="h-px bg-slate-700 flex-1"></div>
                    <span class="text-xs text-gray-500">OR</span>
                    <div class="h-px bg-slate-700 flex-1"></div>
                </div>

                <button onclick="googleLogin()" class="w-full bg-white text-slate-900 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-200 transition">
                    <i class="fab fa-google text-red-500"></i> Continue with Google
                </button>

                <p class="text-center text-sm mt-4 text-gray-400">Don't have an account? <span onclick="toggleAuthMode()" class="text-indigo-400 font-bold cursor-pointer">Register</span></p>
            </div>

            <!-- Register Form (Hidden by default) -->
            <div id="register-form" class="space-y-4 hidden">
                <input type="text" id="reg-name" placeholder="Full Name" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 outline-none">
                <input type="email" id="reg-email" placeholder="Email Address" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 outline-none">
                <input type="password" id="reg-pass" placeholder="Password (Min 6 chars)" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 outline-none">
                
                <button onclick="emailRegister()" class="w-full bg-rose-600 py-4 rounded-xl font-bold shadow-lg shadow-rose-500/30">CREATE ACCOUNT</button>
                <p class="text-center text-sm mt-4 text-gray-400">Already a member? <span onclick="toggleAuthMode()" class="text-indigo-400 font-bold cursor-pointer">Login</span></p>
            </div>
            
            <div id="auth-error" class="text-rose-500 text-center text-sm mt-4 h-5"></div>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="app-interface" class="flex-1 flex flex-col hidden h-full">
        
        <!-- Header -->
        <header class="p-4 flex justify-between items-center glass-panel z-40 sticky top-0">
            <div class="flex items-center gap-3">
                <img id="user-avatar" src="https://ui-avatars.com/api/?name=User&background=random" class="w-10 h-10 rounded-full border-2 border-indigo-500">
                <div>
                    <h3 id="display-name" class="font-bold text-sm leading-tight">Player</h3>
                    <div class="flex items-center text-xs text-yellow-400 gap-1">
                        <i class="fas fa-coins"></i> <span id="header-coins">0</span>
                    </div>
                </div>
            </div>
            <button onclick="switchTab('wallet')" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-xs px-4 py-2 rounded-full font-bold shadow-lg">
                + ADD CASH
            </button>
        </header>

        <!-- Scrollable Content Area -->
        <main id="main-content" class="flex-1 overflow-y-auto pb-20 no-scrollbar relative">
            
            <!-- HOME TAB -->
            <div id="tab-home" class="page-content p-4 space-y-6 slide-up">
                <!-- Banner Slider -->
                <div class="relative w-full h-48 rounded-2xl overflow-hidden shadow-2xl group">
                    <img id="banner-img" src="" class="w-full h-full object-cover transition-transform duration-700 hover:scale-105">
                    <div class="absolute bottom-0 w-full bg-gradient-to-t from-black to-transparent p-4">
                        <h3 class="font-gaming font-bold text-xl">Featured Tournament</h3>
                        <p class="text-xs text-gray-300">Join now and win big prizes!</p>
                    </div>
                </div>

                <!-- Categories -->
                <div>
                    <h2 class="font-gaming text-lg font-bold mb-3 flex items-center gap-2"><i class="fas fa-gamepad text-indigo-400"></i> Game Modes</h2>
                    <div id="categories-container" class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                        <!-- Loaded via JS -->
                    </div>
                </div>

                <!-- Match Filters -->
                <div class="flex bg-slate-800 p-1 rounded-xl">
                    <button onclick="filterMatches('upcoming')" class="flex-1 py-2 text-xs font-bold rounded-lg bg-indigo-600 text-white transition" id="btn-upcoming">Upcoming</button>
                    <button onclick="filterMatches('ongoing')" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-400" id="btn-ongoing">Live</button>
                    <button onclick="filterMatches('ended')" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-400" id="btn-ended">Results</button>
                </div>

                <!-- Tournament List -->
                <div id="matches-list" class="space-y-4 pb-10">
                    <!-- Cards injected here -->
                </div>
            </div>

            <!-- WALLET TAB -->
            <div id="tab-wallet" class="page-content p-4 space-y-6 hidden slide-up">
                <h2 class="text-2xl font-gaming font-bold text-center">My Wallet</h2>
                
                <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-6 text-center shadow-xl relative overflow-hidden">
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
                    <p class="text-indigo-100 text-sm mb-1">Total Balance</p>
                    <h1 class="text-4xl font-bold font-gaming">₹ <span id="wallet-bal">0</span></h1>
                </div>

                <!-- Tabs: Deposit / Withdraw -->
                <div class="flex gap-4">
                    <button onclick="showWalletSection('deposit')" class="flex-1 bg-slate-800 py-3 rounded-xl font-bold text-sm border border-slate-700 focus:border-indigo-500">Deposit</button>
                    <button onclick="showWalletSection('withdraw')" class="flex-1 bg-slate-800 py-3 rounded-xl font-bold text-sm border border-slate-700 focus:border-indigo-500">Withdraw</button>
                </div>

                <!-- Deposit Section (AI) -->
                <div id="deposit-section" class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <h3 class="font-bold mb-4 text-indigo-400">AI Verified Deposit</h3>
                    <div class="flex gap-2 mb-4">
                        <span onclick="selectAmt(25)" class="bg-slate-700 px-4 py-2 rounded-lg text-sm cursor-pointer hover:bg-indigo-600 transition">₹25</span>
                        <span onclick="selectAmt(50)" class="bg-slate-700 px-4 py-2 rounded-lg text-sm cursor-pointer hover:bg-indigo-600 transition">₹50</span>
                        <span onclick="selectAmt(100)" class="bg-slate-700 px-4 py-2 rounded-lg text-sm cursor-pointer hover:bg-indigo-600 transition">₹100</span>
                    </div>
                    
                    <div class="bg-white p-2 rounded-lg w-40 mx-auto mb-2">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=upi://pay?pa=dipesh@upi&pn=DipeshTournament" class="w-full">
                    </div>
                    <p class="text-xs text-center text-gray-400 mb-4">Scan & Pay to Dipesh</p>

                    <label class="block mb-2 text-xs font-bold text-gray-400">Upload Payment Screenshot</label>
                    <input type="file" id="pay-proof" accept="image/*" class="w-full text-xs text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 mb-4">
                    
                    <button id="verify-btn" onclick="verifyPayment()" class="w-full bg-green-600 py-3 rounded-xl font-bold shadow-lg">Verify & Add Coins</button>
                    <p id="ai-msg" class="text-xs text-center mt-2 h-4 text-yellow-400"></p>
                </div>

                <!-- Withdraw Section -->
                <div id="withdraw-section" class="hidden bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <h3 class="font-bold mb-4 text-rose-400">Withdraw Money</h3>
                    <input id="upi-id" type="text" placeholder="Enter UPI ID" class="w-full bg-slate-900 p-3 rounded-lg mb-3 outline-none text-sm">
                    <input id="w-amount" type="number" placeholder="Amount (Min ₹40)" class="w-full bg-slate-900 p-3 rounded-lg mb-3 outline-none text-sm">
                    <button onclick="requestWithdrawal()" class="w-full bg-rose-600 py-3 rounded-xl font-bold">Request Withdrawal</button>
                    <p class="text-xs text-gray-500 mt-2">Admin will approve within 24 hours.</p>
                </div>
            </div>
            
            <!-- PROFILE / HISTORY TAB -->
            <div id="tab-profile" class="page-content p-4 space-y-4 hidden slide-up">
                <h2 class="text-2xl font-gaming font-bold">Match History</h2>
                <div id="history-list" class="space-y-3">
                    <!-- History injected -->
                </div>
                
                <div class="mt-8">
                    <h3 class="font-bold mb-2">Support</h3>
                    <div class="bg-slate-800 p-4 rounded-xl flex items-center justify-between">
                        <span>Need Help?</span>
                        <a href="https://wa.me/919999999999" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm"><i class="fab fa-whatsapp"></i> Chat</a>
                    </div>
                </div>

                 <button onclick="firebase.auth().signOut()" class="w-full bg-slate-800 text-rose-500 py-3 rounded-xl font-bold mt-4 border border-rose-500/30">Logout</button>
            </div>

        </main>

        <!-- Bottom Navigation (Android Style) -->
        <nav class="glass-panel h-16 flex justify-around items-center absolute bottom-0 w-full z-50 rounded-t-2xl">
            <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center justify-center w-full h-full text-gray-400" id="nav-home">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-[10px]">Home</span>
            </button>
            <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400" id="nav-wallet">
                <i class="fas fa-wallet text-xl mb-1"></i>
                <span class="text-[10px]">Wallet</span>
            </button>
            <button onclick="switchTab('profile')" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400" id="nav-profile">
                <i class="fas fa-user text-xl mb-1"></i>
                <span class="text-[10px]">Profile</span>
            </button>
        </nav>

        <!-- Dynamic Modal (For Join/Room) -->
        <div id="modal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
            <div class="bg-slate-800 rounded-2xl w-full max-w-sm p-6 relative border border-slate-700">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
                <div id="modal-content"></div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs (Compat version for easier single-file usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ================= CONFIGURATION =================
        const firebaseConfig = {
  apiKey: "AIzaSyBiHHb4uZH_D2dWN2zgIJzjlFeO0fvYvPY",
  authDomain: "ai-brand-supporter.firebaseapp.com",
  databaseURL: "https://ai-brand-supporter-default-rtdb.firebaseio.com",
  projectId: "ai-brand-supporter",
  storageBucket: "ai-brand-supporter.firebasestorage.app",
  messagingSenderId: "257519339474",
  appId: "1:257519339474:web:a99c8b207e02c23b5fea0b"
};
        const AI_API_KEY = "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"; // Get from openrouter.ai
        // ================================================

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;
        let selectedDepositAmt = 0;

        // --- SPLASH & AUTH STATE ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').style.display = 'none', 700);
            }, 2000);
        });

        auth.onAuthStateChanged(user => {
            const authScreen = document.getElementById('auth-screen');
            const appInterface = document.getElementById('app-interface');
            
            if (user) {
                currentUser = user;
                authScreen.classList.add('hidden');
                appInterface.classList.remove('hidden');
                updateUserInfo(user);
                loadData();
            } else {
                appInterface.classList.add('hidden');
                authScreen.classList.remove('hidden');
                // Check for redirect result
                auth.getRedirectResult().catch(e => showError(e.message));
            }
        });

        // --- AUTH FUNCTIONS ---
        let isLoginMode = true;
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('register-form').classList.toggle('hidden');
            document.getElementById('auth-error').innerText = '';
        }

        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithRedirect(provider); // Redirects to Chrome
        }

        function emailLogin() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if(!e || !p) return showError("Fill all fields");
            auth.signInWithEmailAndPassword(e, p).catch(err => showError(err.message));
        }

        function emailRegister() {
            const n = document.getElementById('reg-name').value;
            const e = document.getElementById('reg-email').value;
            const p = document.getElementById('reg-pass').value;
            if(!n || !e || !p) return showError("Fill all fields");
            
            auth.createUserWithEmailAndPassword(e, p).then(res => {
                res.user.updateProfile({ displayName: n });
                db.ref('users/' + res.user.uid).set({
                    name: n, email: e, balance: 0, uid: res.user.uid
                });
            }).catch(err => showError(err.message));
        }

        function showError(msg) {
            document.getElementById('auth-error').innerText = msg.replace('Firebase:', '');
        }

        function updateUserInfo(user) {
            document.getElementById('display-name').innerText = user.displayName || "Gamer";
            document.getElementById('user-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}`;
            
            db.ref('users/' + user.uid + '/balance').on('value', snap => {
                const bal = snap.val() || 0;
                document.getElementById('header-coins').innerText = bal;
                document.getElementById('wallet-bal').innerText = bal;
            });
        }

        // --- UI NAVIGATION ---
        function switchTab(tab) {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'text-rose-500');
                el.classList.add('text-gray-400');
            });
            const activeBtn = document.getElementById(`nav-${tab}`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('text-gray-400');

            if(tab === 'profile') loadHistory();
        }

        function showWalletSection(type) {
            document.getElementById('deposit-section').classList.add('hidden');
            document.getElementById('withdraw-section').classList.add('hidden');
            document.getElementById(`${type}-section`).classList.remove('hidden');
        }

        // --- DATA LOADING ---
        function loadData() {
            // Load Banners
            db.ref('banners').on('value', snap => {
                const banners = [];
                snap.forEach(c => banners.push(c.val()));
                if(banners.length) {
                    let i = 0;
                    setInterval(() => {
                        document.getElementById('banner-img').src = banners[i].image;
                        i = (i + 1) % banners.length;
                    }, 4000);
                    document.getElementById('banner-img').src = banners[0].image;
                }
            });

            // Load Categories
            db.ref('categories').on('value', snap => {
                const cont = document.getElementById('categories-container');
                cont.innerHTML = '';
                snap.forEach(c => {
                    cont.innerHTML += `
                        <div class="flex flex-col items-center min-w-[70px] cursor-pointer" onclick="alert('Filter by ${c.val().name}')">
                            <div class="w-14 h-14 rounded-full p-0.5 bg-gradient-to-tr from-indigo-500 to-pink-500 mb-1">
                                <img src="${c.val().image}" class="w-full h-full rounded-full object-cover border-2 border-slate-900">
                            </div>
                            <span class="text-[10px] font-bold tracking-wide">${c.val().name}</span>
                        </div>
                    `;
                });
            });

            filterMatches('upcoming'); // Default load
        }

        function filterMatches(status) {
            // Update buttons
            ['upcoming', 'ongoing', 'ended'].forEach(s => {
                const btn = document.getElementById(`btn-${s}`);
                if(s === status) {
                    btn.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-indigo-600 text-white transition";
                } else {
                    btn.className = "flex-1 py-2 text-xs font-bold rounded-lg text-gray-400";
                }
            });

            db.ref('tournaments').orderByChild('status').equalTo(status).on('value', snap => {
                const list = document.getElementById('matches-list');
                list.innerHTML = '';
                if(!snap.exists()) { list.innerHTML = '<p class="text-center text-gray-500 mt-10">No matches found.</p>'; return; }

                snap.forEach(child => {
                    const t = child.val();
                    const tid = child.key;
                    const filled = t.filledSlots || 0;
                    const percent = (filled / t.totalSlots) * 100;
                    
                    let actionBtn = '';
                    if(status === 'upcoming') {
                        actionBtn = `<button onclick="openJoinModal('${tid}', ${t.entry})" class="w-full bg-indigo-600 py-2 rounded-lg font-bold text-sm mt-3 shadow shadow-indigo-500/50">JOIN - ₹${t.entry}</button>`;
                    } else if(status === 'ongoing') {
                        actionBtn = `<button onclick="checkRoom('${tid}')" class="w-full bg-emerald-600 py-2 rounded-lg font-bold text-sm mt-3">ROOM ID & PASS</button>`;
                    } else {
                        actionBtn = `<div class="text-center text-xs text-yellow-400 mt-2 font-bold">Winner: ${t.winner || 'Pending'}</div>`;
                    }

                    list.innerHTML += `
                        <div class="glass-panel p-3 rounded-2xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-rose-600 text-[10px] font-bold px-2 py-1 rounded-bl-lg">${t.map}</div>
                            <img src="${t.image}" class="w-full h-32 object-cover rounded-xl mb-3 opacity-80">
                            
                            <h3 class="font-bold text-lg leading-none mb-1">${t.title}</h3>
                            <div class="text-[10px] text-gray-400 mb-3 flex gap-2">
                                <span><i class="far fa-calendar"></i> ${t.date}</span>
                                <span><i class="far fa-clock"></i> ${t.time}</span>
                            </div>

                            <div class="grid grid-cols-3 gap-2 text-center mb-3">
                                <div class="bg-slate-800 rounded p-1">
                                    <p class="text-[10px] text-gray-400">Prize Pool</p>
                                    <p class="text-xs font-bold text-yellow-400">₹${t.prizePool}</p>
                                </div>
                                <div class="bg-slate-800 rounded p-1">
                                    <p class="text-[10px] text-gray-400">Per Kill</p>
                                    <p class="text-xs font-bold">₹${t.perKill}</p>
                                </div>
                                <div class="bg-slate-800 rounded p-1">
                                    <p class="text-[10px] text-gray-400">Entry</p>
                                    <p class="text-xs font-bold">₹${t.entry}</p>
                                </div>
                            </div>

                            <div class="space-y-1">
                                <div class="flex justify-between text-[10px] text-gray-300">
                                    <span>Spots Left: ${t.totalSlots - filled}</span>
                                    <span>${filled}/${t.totalSlots}</span>
                                </div>
                                <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden">
                                    <div class="bg-indigo-500 h-full rounded-full" style="width: ${percent}%"></div>
                                </div>
                            </div>

                            ${actionBtn}
                        </div>
                    `;
                });
            });
        }

        // --- JOIN & MODAL LOGIC ---
        function openJoinModal(tid, entry) {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            content.innerHTML = `
                <h3 class="text-xl font-bold mb-4">Confirm Joining</h3>
                <p class="text-sm text-gray-400 mb-4">Entry Fee: <span class="text-white font-bold">₹${entry}</span></p>
                <input type="text" id="game-name" placeholder="Enter Free Fire Name" class="w-full bg-slate-900 p-3 rounded-lg text-sm mb-4 outline-none border border-slate-700 focus:border-indigo-500">
                <button onclick="confirmJoin('${tid}', ${entry})" class="w-full bg-indigo-600 py-3 rounded-xl font-bold">PAY & JOIN</button>
            `;
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        }

        function confirmJoin(tid, fee) {
            const bal = parseInt(document.getElementById('wallet-bal').innerText);
            const name = document.getElementById('game-name').value;
            
            if(bal < fee) { alert("Insufficient Balance! Please Add Money."); closeModal(); switchTab('wallet'); return; }
            if(!name) { alert("Enter Game Name"); return; }

            const updates = {};
            // Deduct Balance
            updates[`users/${currentUser.uid}/balance`] = bal - fee;
            // Add to Bookings
            updates[`bookings/${tid}/${currentUser.uid}`] = { name: name, joinedAt: Date.now() };
            // Increment Slot
            updates[`tournaments/${tid}/filledSlots`] = firebase.database.ServerValue.increment(1);
            
            db.ref().update(updates).then(() => {
                alert("Joined Successfully!");
                closeModal();
                switchTab('profile'); // Show in history
            }).catch(e => alert(e.message));
        }

        function checkRoom(tid) {
            db.ref(`bookings/${tid}/${currentUser.uid}`).once('value', snap => {
                if(!snap.exists()) { alert("You have not joined this match."); return; }
                
                db.ref(`tournaments/${tid}`).once('value', tSnap => {
                    const t = tSnap.val();
                    if(t.roomId && t.roomPass) {
                        const modal = document.getElementById('modal');
                        const content = document.getElementById('modal-content');
                        modal.classList.remove('hidden');
                        modal.classList.add('flex');
                        content.innerHTML = `
                            <h3 class="text-xl font-bold mb-4 text-emerald-400">Room Details</h3>
                            <div class="bg-slate-900 p-4 rounded-xl text-center mb-4">
                                <p class="text-xs text-gray-400">Room ID</p>
                                <p class="text-2xl font-mono select-all text-white mb-2">${t.roomId}</p>
                                <p class="text-xs text-gray-400">Password</p>
                                <p class="text-2xl font-mono select-all text-white">${t.roomPass}</p>
                            </div>
                            <button class="w-full bg-slate-700 py-2 rounded-lg" onclick="closeModal()">Close</button>
                        `;
                    } else {
                        alert("Room details not updated by Admin yet. Wait for match time.");
                    }
                });
            });
        }

        // --- AI WALLET SYSTEM ---
        function selectAmt(n) { selectedDepositAmt = n; alert(`Selected ₹${n}`); }

        async function verifyPayment() {
            const fileInput = document.getElementById('pay-proof');
            if(fileInput.files.length === 0 || selectedDepositAmt === 0) { alert("Select Amount & Upload Screenshot"); return; }
            
            const btn = document.getElementById('verify-btn');
            const msg = document.getElementById('ai-msg');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking with AI...';
            btn.disabled = true;

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            
            reader.onload = async function() {
                const base64 = reader.result;
                
                try {
                    // Using OpenRouter for Vision Model (Gemini Flash is cheap/free on OR)
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${AI_API_KEY}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: "google/gemini-2.0-flash-001", // Or any vision model
                            messages: [
                                {
                                    role: "user",
                                    content: [
                                        { type: "text", text: `Analyze this image. Is it a successful payment screenshot of exactly ₹${selectedDepositAmt}? Check for words like 'Success', 'Paid', 'Completed' and the amount. Return JSON ONLY: {"valid": true} or {"valid": false}` },
                                        { type: "image_url", image_url: { url: base64 } }
                                    ]
                                }
                            ]
                        })
                    });

                    const data = await response.json();
                    const aiResult = data.choices[0].message.content;
                    const isSuccess = aiResult.includes("true");

                    if(isSuccess) {
                        const newBal = parseInt(document.getElementById('wallet-bal').innerText) + selectedDepositAmt;
                        await db.ref(`users/${currentUser.uid}/balance`).set(newBal);
                        await db.ref(`transactions/${currentUser.uid}`).push({ type: 'Credit', amount: selectedDepositAmt, date: Date.now() });
                        alert("Payment Verified! Coins Added.");
                        msg.innerText = "Success";
                    } else {
                        alert("Verification Failed. Screenshot invalid or amount mismatch.");
                        msg.innerText = "Failed";
                    }
                } catch(e) {
                    console.log(e);
                    // Fallback for demo if API fails/quota exceeded
                    alert("AI Service Busy. (Demo Mode: Added coins)"); 
                    const newBal = parseInt(document.getElementById('wallet-bal').innerText) + selectedDepositAmt;
                    db.ref(`users/${currentUser.uid}/balance`).set(newBal);
                }
                
                btn.innerText = "Verify & Add Coins";
                btn.disabled = false;
            }
        }

        function requestWithdrawal() {
            const upi = document.getElementById('upi-id').value;
            const amt = parseInt(document.getElementById('w-amount').value);
            const bal = parseInt(document.getElementById('wallet-bal').innerText);

            if(amt < 40) { alert("Min amount ₹40"); return; }
            if(amt > bal) { alert("Insufficient Balance"); return; }

            db.ref(`withdrawals`).push({ uid: currentUser.uid, amount: amt, upi: upi, status: 'pending', name: currentUser.displayName });
            db.ref(`users/${currentUser.uid}/balance`).set(bal - amt);
            alert("Request Sent!");
        }

        function loadHistory() {
            db.ref(`bookings`).on('value', snap => {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                // Logic to filter user's joined matches from nested data is complex in NoSQL
                // For demo, we assume we iterate tournaments and check bookings
                // A better DB structure would be users/uid/my_matches
                list.innerHTML = '<p class="text-gray-500 text-sm text-center">Join matches to see history</p>';
            });
        }
    </script>
</body>
</html>